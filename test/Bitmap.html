<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
    <script src="../dist/Moco.js"></script>
</head>
<body>
<div id="wrap1" style="position:absolute;top:0;left:0;width:1000px;height:1000px;overflow: hidden;">
    <div id="wrap2" style="position:absolute;top:0;left:0;width:400px;height:300px;overflow:hidden;">
        <canvas id="canvas" width="800" height="600"></canvas>
    </div>
</div>
<script>
    var Moco = require("Moco");
    var stage = new Moco.Stage("canvas", function () {
        console.log("start!");
    });
    var loader = new Moco.Loader();
    loader.on(Moco.LoaderEvent.COMPLETE, function (ev) {
        var target = ev.target;
        var translateMreix = Moco.Matrix3.translation(0, 0);
        var scaleMatrix = Moco.Matrix3.scaling(1, 1);
        var rotateMatrix = Moco.Matrix3.rotation(0);
        rotateMatrix.multi(scaleMatrix);
        translateMreix.multi(rotateMatrix);
        var bmd = target.toBitmapData(translateMreix);
        var bm = new Moco.Bitmap(bmd);

        var shape = new Moco.Shape();
        shape.drawRect(30, 0xffffff, [15, 0, 0, 119], false, 0xffffff);
        var mask = new Moco.Sprite();
        mask.graphics = shape;
        mask.globalCompositeOperation = "destination-in";
        mask.alpha = 0.8;

        var sprite = new Moco.Sprite();
        sprite.addChild(bm);
        stage.addChild(sprite);
        sprite.once(Moco.Event.ADD_TO_STAGE, function () {
            //animate();
        });

        function animate() {
            Moco.Animate.to(mask, {
                x: 89,
                onComplete: function () {
                    Moco.Animate.to(mask, {
                        x: 0,
                        onComplete: function () {
                            animate();
                        }
                    });
                }
            });
        }

        stage.addChild(mask);

        sprite.on(Moco.MouseEvent.CLICK, function () {
            console.log("in?");
        });
        window.s = sprite;

//       console.time("def");
//       bmd.lock();
//       for (var i = 0; i < 1000; i++) {
//           var x = Math.random() * 800;
//           var y = Math.random() * 600;
//           var tmp = bmd.getPixel(x, y);
//           bmd.setPixel(x, y, tmp);
//       }
//       bmd.unlock();
//       console.timeEnd("def");
    });
    loader.on(Moco.LoaderEvent.ERROR, function () {
        console.log("load img error");
    });
    loader.load(new Moco.URLRequest("../images/qr-weixin.png"));
</script>
</body>
</html>
